{% extends "base.html" %}

{% block title %}管理面板 - 康乃薾幼兒園出缺勤打卡系統{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li><a href="{{ url_for('index') }}">首頁</a></li>
        <li>管理面板</li>
    </ol>
</nav>

<div class="dashboard">
    <div class="dashboard-card">
        <h3>今日打卡人數</h3>
        <p id="today-punch-count" class="loading"></p>
    </div>
    <div class="dashboard-card">
        <h3>待審核請假</h3>
        <p id="pending-leave-requests" class="loading"></p>
    </div>
    <div class="dashboard-card">
        <h3>本月累計請假時數</h3>
        <p id="total-leave-hours" class="loading"></p>
    </div>
</div>

<div class="chart-container">
    <canvas id="leaveChart"></canvas>
</div>

<div class="admin-dashboard">
    <h2 class="page-title"><i class="fas fa-tachometer-alt"></i> 管理面板</h2>

    <div class="dashboard-overview">
        <div class="stat-card">
            <i class="fas fa-user-clock fa-2x"></i>
            <h3>今日上班打卡人數</h3>
            <p id="today-punch-count" class="stat-value skeleton">--</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-calendar-check fa-2x"></i>
            <h3>待審核請假</h3>
            <p id="pending-leave-requests" class="stat-value skeleton">--</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-hourglass-half fa-2x"></i>
            <h3>本月累計請假時數</h3>
            <p id="total-leave-hours" class="stat-value skeleton">--</p>
        </div>
    </div>

    <div class="admin-sections">
        <div class="admin-section card">
            <h3 class="section-title collapsible"><i class="fas fa-clock"></i> 打卡記錄 <i class="fas fa-chevron-down"></i></h3>
            <div class="section-content">
                <div class="filter-section">
                    <form method="GET" action="{{ url_for('admin') }}" class="filter-form">
                        <div class="form-group">
                            <label for="employee"><i class="fas fa-user"></i> 員工：</label>
                            <select name="employee" id="employee">
                                <option value="">全部</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {% if user.id|string == selected_employee %}selected{% endif %}>{{ user.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="start_date"><i class="fas fa-calendar-alt"></i> 開始日期：</label>
                            <input type="date" name="start_date" id="start_date" value="{{ start_date }}">
                        </div>
                        <div class="form-group">
                            <label for="end_date"><i class="fas fa-calendar-alt"></i> 結束日期：</label>
                            <input type="date" name="end_date" id="end_date" value="{{ end_date }}">
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> 篩選</button>
                    </form>
                </div>
                <div class="table-responsive">
                    {% if records %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>
                                    <a href="{{ url_for('admin', sort_by='user', sort_order='asc' if sort_by == 'user' and sort_order == 'desc' else 'desc') }}">
                                        姓名 {% if sort_by == 'user' %}{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="{{ url_for('admin', sort_by='punch_time', sort_order='asc' if sort_by == 'punch_time' and sort_order == 'desc' else 'desc') }}">
                                        打卡時間 {% if sort_by == 'punch_time' %}{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th>打卡類型</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.user.name }}</td>
                                <td>{{ record.punch_time|format_datetime }}</td>
                                <td>{{ punch_type_names.get(record.punch_type, record.punch_type) }}</td>
                                <td>
                                    <button class="btn btn-sm btn-edit" onclick="editRecord({{ record.id }})"><i class="fas fa-edit"></i> 編輯</button>
                                    <button class="btn btn-sm btn-delete" onclick="deleteRecord({{ record.id }})"><i class="fas fa-trash-alt"></i> 刪除</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="no-data">沒有找到符合條件的打卡記錄。</p>
                    {% endif %}
                </div>
                <div class="pagination">
                    {{ render_pagination(records_pagination, 'admin', employee=selected_employee, start_date=start_date, end_date=end_date) }}
                </div>
            </div>
        </div>

        <div class="admin-section card">
            <h3 class="section-title collapsible"><i class="fas fa-calendar-alt"></i> 請假記錄 <i class="fas fa-chevron-down"></i></h3>
            <div class="section-content">
                <div class="table-responsive">
                    {% if leave_requests %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>員工</th>
                                <th>請假類型</th>
                                <th>時間</th>
                                <th>交接事宜</th>
                                <th>代理人</th>
                                <th>代理人確認</th>
                                <th>人事審核</th>
                                <th>主管審核</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in leave_requests %}
                            <tr>
                                <td><input type="checkbox" class="leave-request-checkbox" data-id="{{ request.id }}"></td>
                                <td>{{ request.user.name }}</td>
                                <td>{{ leave_type_names.get(request.leave_type, request.leave_type) }}</td>
                                <td>{{ request.start_datetime|format_datetime('%Y-%m-%d %H:%M') }} - {{ request.end_datetime|format_datetime('%Y-%m-%d %H:%M') }} ({{ request.duration_str }})</td>
                                <td>
                                    <div class="scrollable-content" title="{{ request.handover_notes }}">
                                        {{ request.handover_notes }}
                                    </div>
                                </td>
                                <td>{{ request.deputy.name if request.deputy else '無' }}</td>
                                <td><span class="status-badge {% if request.deputy_confirmation %}confirmed{% else %}unconfirmed{% endif %}">{{ '已確認' if request.deputy_confirmation else '未確認' }}</span></td>
                                <td><span class="status-badge {% if request.hr_approval == 0 %}pending{% elif request.hr_approval == 1 %}approved{% else %}rejected{% endif %}">{{ '待審核' if request.hr_approval == 0 else '已批准' if request.hr_approval == 1 else '已駁回' }}</span></td>
                                <td><span class="status-badge {% if request.manager_approval == 0 %}pending{% elif request.manager_approval == 1 %}approved{% else %}rejected{% endif %}">{{ '待審核' if request.manager_approval == 0 else '已批准' if request.manager_approval == 1 else '已駁回' }}</span></td>
                                <td>
                                    {% if current_user.role in ['管理員', '人事'] and request.hr_approval == 0 %}
                                        <button class="btn btn-sm btn-approve" onclick="approveLeave({{ request.id }}, 'hr')"><i class="fas fa-check"></i> 人事批准</button>
                                        <button class="btn btn-sm btn-reject" onclick="rejectLeave({{ request.id }}, 'hr')"><i class="fas fa-times"></i> 人事駁回</button>
                                    {% elif current_user.role in ['管理員', '主管'] and request.manager_approval == 0 %}
                                        <button class="btn btn-sm btn-approve" onclick="approveLeave({{ request.id }}, 'manager')"><i class="fas fa-check"></i> 主管批准</button>
                                        <button class="btn btn-sm btn-reject" onclick="rejectLeave({{ request.id }}, 'manager')"><i class="fas fa-times"></i> 主管駁回</button>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="no-data">沒有找到符合條件的請假記錄。</p>
                    {% endif %}
                </div>
                <div class="pagination">
                    {{ render_pagination(leave_requests_pagination, 'admin', employee=selected_employee, start_date=start_date, end_date=end_date) }}
                </div>
                <div class="bulk-actions">
                    {% if current_user.role in ['管理員', '人事'] %}
                    <button id="bulk-approve-hr" class="btn btn-approve"><i class="fas fa-check-double"></i> 批量人事批准</button>
                    {% endif %}
                    {% if current_user.role in ['管理員', '主管'] %}
                    <button id="bulk-approve-manager" class="btn btn-approve"><i class="fas fa-check-double"></i> 批量主管批准</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 加載儀表板數據
function loadDashboardData() {
    fetch('/api/dashboard_stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('today-punch-count').textContent = data.today_punch_count;
            document.getElementById('pending-leave-requests').textContent = data.pending_leave_requests;
            document.getElementById('total-leave-hours').textContent = data.total_leave_hours.toFixed(1) + ' 小時';
            
            // 移除加載動畫
            document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));
        });
}

// 初始化圖表
function initChart() {
    fetch('/api/leave_stats')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('leaveChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: '請假天數',
                        data: data.map(d => d.days),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
}

loadDashboardData();
initChart();

document.getElementById('select-all').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.leave-request-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
    });
});

{% if current_user.role in ['管理員', '人事'] %}
document.getElementById('bulk-approve-hr').addEventListener('click', function() {
    const selectedIds = Array.from(document.querySelectorAll('.leave-request-checkbox:checked')).map(checkbox => checkbox.dataset.id);
    if (selectedIds.length > 0) {
        fetch('/bulk_approve_leave', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_ids: selectedIds,
                approver_type: 'hr'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        });
    } else {
        alert('請選擇要批量審批的請假記錄');
    }
});
{% endif %}

{% if current_user.role in ['管理員', '主管'] %}
document.getElementById('bulk-approve-manager').addEventListener('click', function() {
    const selectedIds = Array.from(document.querySelectorAll('.leave-request-checkbox:checked')).map(checkbox => checkbox.dataset.id);
    if (selectedIds.length > 0) {
        fetch('/bulk_approve_leave', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_ids: selectedIds,
                approver_type: 'manager'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        });
    } else {
        alert('請選擇要批量審批的請假記錄');
    }
});
{% endif %}

function editRecord(recordId) {
    // 實現編輯記錄的邏輯
}

function deleteRecord(recordId) {
    if (confirm('確定要刪除這條記錄嗎？')) {
        // 實現刪除記錄的邏輯
    }
}

function approveLeave(requestId, approverType) {
    // 實現批准請假的邏輯
}

function rejectLeave(requestId, approverType) {
    // 實現駁回請假的邏輯
}

// 添加摺疊/展開功能
document.querySelectorAll('.collapsible').forEach(item => {
    item.addEventListener('click', event => {
        event.target.classList.toggle('active');
        var content = event.target.nextElementSibling;
        if (content.style.display === "none") {
            content.style.display = "block";
        } else {
            content.style.display = "none";
        }
    });
});
</script>
{% endblock %}
