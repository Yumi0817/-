{% extends "base.html" %}

{% block content %}
<h1>請假統計</h1>

<form method="get">
    {% if current_user.role in ['管理員', '人事', '主管'] %}
    <label for="user_id">員工：</label>
    <select id="user_id" name="user_id">
        <option value="">所有員工</option>
        {% for user in users %}
            <option value="{{ user.id }}" {% if user.id|string == selected_user_id %}selected{% endif %}>{{ user.name }}</option>
        {% endfor %}
    </select>
    {% endif %}

    <label for="start_date">開始日期：</label>
    <input type="date" id="start_date" name="start_date" value="{{ start_date }}">

    <label for="end_date">結束日期：</label>
    <input type="date" id="end_date" name="end_date" value="{{ end_date }}">

    <label for="leave_type">請假類型：</label>
    <select id="leave_type" name="leave_type">
        <option value="">所有類型</option>
        {% for key, value in leave_type_names.items() %}
            <option value="{{ key }}" {% if key == selected_leave_type %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
    </select>

    <button type="submit">篩選</button>
</form>

<h2>總覽 ({{ start_date }} 至 {{ end_date }})</h2>
<table class="table">
    <thead>
        <tr>
            <th>用戶</th>
            {% if not selected_leave_type %}
                {% for leave_type, leave_name in leave_type_names.items() %}
                    <th>{{ leave_name }}</th>
                {% endfor %}
            {% else %}
                <th>{{ leave_type_names[selected_leave_type] }}</th>
            {% endif %}
            <th>總計</th>
        </tr>
    </thead>
    <tbody>
        {% for user_id, leave_data in statistics.items() %}
            <tr>
                <td>{{ user_names[user_id] }}</td>
                {% set total_hours = 0 %}
                {% if not selected_leave_type %}
                    {% for leave_type in leave_type_names %}
                        {% set hours = leave_data.get(leave_type, 0) %}
                        <td>{{ "%.1f"|format(hours) }}</td>
                        {% set total_hours = total_hours + hours %}
                    {% endfor %}
                {% else %}
                    {% set hours = leave_data.get(selected_leave_type, 0) %}
                    <td>{{ "%.1f"|format(hours) }}</td>
                    {% set total_hours = hours %}
                {% endif %}
                <td>{{ "%.1f"|format(total_hours) }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
